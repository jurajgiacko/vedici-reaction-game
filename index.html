<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>VEDICI Focus Challenge | Test Your Reaction Speed</title>
    <meta name="description" content="Measure your reaction time and discover your edge. Play the VEDICI Focus Challenge.">
    
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-firestore-compat.js"></script>
    
    <!-- Styles -->
    <link rel="stylesheet" href="styles.css">
</head>
<body>
    <!-- Logo/Brand -->
    <a href="https://vedici.gg" class="logo" target="_blank">VEDICI</a>

    <div class="game-container">
        <!-- Start Screen -->
        <div class="start-screen" id="startScreen">
            <h1>VEDICI FOCUS CHALLENGE</h1>
            <p class="tagline">Test your focus. Join the Golden Edge.</p>
            <button class="btn" onclick="startGame()">START CHALLENGE</button>
            <button class="btn btn-secondary" onclick="showLeaderboard()">üèÜ LEADERBOARD</button>
        </div>

        <!-- Game Area -->
        <div class="game-area" id="gameArea" onclick="handleClick(event)">
            <div class="glow-circle"></div>
            <div class="glow-circle"></div>
            <div class="glow-circle"></div>
            <div class="round-indicator" id="roundIndicator"></div>
            <div class="instruction" id="instruction">Wait for GOLD...</div>
        </div>

        <!-- Results Screen -->
        <div class="results-screen" id="resultsScreen">
            <div class="result-header">
                <h2>CHALLENGE COMPLETE</h2>
                <div class="result-time" id="averageTime">0ms</div>
            </div>
            <div class="result-message">Average Reaction Time</div>
            <div class="rounds-survived" id="roundsSurvived">You'd survive 0 rounds in VEDICI mode</div>
            
            <div id="leaderboardContainer"></div>
            
            <div class="button-group">
                <button class="btn" onclick="saveAndShowLeaderboard()">SAVE SCORE</button>
                <button class="btn btn-secondary" onclick="startGame()">PLAY AGAIN</button>
                <button class="btn btn-secondary" onclick="window.open('https://vedici.gg/gameon', '_blank')">GET YOUR EDGE ‚Üí</button>
            </div>
        </div>

        <!-- Analytics Screen -->
        <div class="analytics-screen" id="analyticsScreen" style="display: none;">
            <h2>üìä ANALYTICS</h2>
            <div class="analytics-controls">
                <div class="date-range-selector">
                    <label>Select Period:</label>
                    <select id="periodSelect" onchange="updateAnalytics()">
                        <option value="today">Today</option>
                        <option value="yesterday">Yesterday</option>
                        <option value="week">Last 7 days</option>
                        <option value="month">Last 30 days</option>
                        <option value="all">All time</option>
                        <option value="custom">Custom Range</option>
                    </select>
                </div>
                <div class="custom-date-range" id="customDateRange" style="display: none;">
                    <div>
                        <label>From:</label>
                        <input type="date" id="dateFrom" onchange="updateAnalytics()">
                    </div>
                    <div>
                        <label>To:</label>
                        <input type="date" id="dateTo" onchange="updateAnalytics()">
                    </div>
                </div>
            </div>
            <div class="analytics-stats" id="analyticsStats">
                <div class="stat-card">
                    <div class="stat-value" id="totalGames">0</div>
                    <div class="stat-label">Total Games</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="avgReactionTime">0ms</div>
                    <div class="stat-label">Avg Reaction Time</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="uniquePlayers">0</div>
                    <div class="stat-label">Unique Players</div>
                </div>
            </div>
            <div class="button-group" style="max-width: 300px; margin-top: 2rem;">
                <button class="btn btn-secondary" onclick="backToStart()">BACK</button>
            </div>
        </div>

        <!-- Email Input Modal -->
        <div class="modal" id="nameModal">
            <div class="modal-content">
                <h3>SAVE YOUR SCORE</h3>
                <p style="color: #888; margin-bottom: 1rem; font-size: 0.9rem;">Enter your email to save your result to the leaderboard</p>
                <input type="email" class="name-input" id="playerName" placeholder="your.email@example.com" maxlength="100" required autocomplete="email">
                <button class="btn" id="submitButton" onclick="submitScore()">SAVE SCORE</button>
                <button class="btn btn-secondary" onclick="skipSave()">SKIP</button>
                <div class="error-message" id="errorMessage"></div>
            </div>
        </div>
    </div>

    <script>
        // Firebase Configuration - Your specific config
        const firebaseConfig = {
            apiKey: "AIzaSyCvMuK_cxGhu-oCIBoYedbN0nB3QkJ5ghQ",
            authDomain: "vedici-reaction-game.firebaseapp.com",
            projectId: "vedici-reaction-game",
            storageBucket: "vedici-reaction-game.firebasestorage.app",
            messagingSenderId: "368959111382",
            appId: "1:368959111382:web:d1f7ef0043e223a49cc977"
        };

        // Initialize Firebase
        let db;
        let firebaseInitialized = false;
        
        try {
            firebase.initializeApp(firebaseConfig);
            db = firebase.firestore();
            firebaseInitialized = true;
            console.log('Firebase initialized successfully');
        } catch (error) {
            console.error('Firebase initialization error:', error);
            firebaseInitialized = false;
        }

        // Game Variables
        let gameState = 'idle';
        let startTime = 0;
        let reactionTimes = [];
        let currentRound = 0;
        let timeoutId = null;
        let avgReactionTime = 0;
        const TOTAL_ROUNDS = 5;

        // Show/Hide Elements
        function showElement(id) {
            const element = document.getElementById(id);
            element.style.display = 'flex';
        }

        function hideElement(id) {
            const element = document.getElementById(id);
            element.style.display = 'none';
        }

        // Start Game
        function startGame() {
            reactionTimes = [];
            currentRound = 0;
            gameState = 'playing';
            
            hideElement('startScreen');
            hideElement('resultsScreen');
            showElement('gameArea');
            
            nextRound();
        }

        // Next Round
        function nextRound() {
            currentRound++;
            
            if (currentRound > TOTAL_ROUNDS) {
                endGame();
                return;
            }
            
            document.getElementById('roundIndicator').textContent = `Round ${currentRound}/${TOTAL_ROUNDS}`;
            document.getElementById('instruction').textContent = 'Wait for GOLD...';
            
            const gameArea = document.getElementById('gameArea');
            gameArea.className = 'game-area waiting';
            gameState = 'waiting';
            
            // Random delay between 2-6 seconds
            const delay = 2000 + Math.random() * 4000;
            
            timeoutId = setTimeout(() => {
                gameArea.className = 'game-area ready';
                document.getElementById('instruction').textContent = 'CLICK NOW!';
                gameState = 'ready';
                startTime = Date.now();
            }, delay);
        }

        // Create Ripple Effect
        function createRipple(event) {
            const gameArea = document.getElementById('gameArea');
            const ripple = document.createElement('div');
            ripple.classList.add('click-ripple');
            
            const rect = gameArea.getBoundingClientRect();
            const x = event.clientX - rect.left;
            const y = event.clientY - rect.top;
            const size = 120;
            
            ripple.style.width = size + 'px';
            ripple.style.height = size + 'px';
            ripple.style.left = (x - size / 2) + 'px';
            ripple.style.top = (y - size / 2) + 'px';
            
            gameArea.appendChild(ripple);
            
            setTimeout(() => {
                ripple.remove();
            }, 800);
        }

        // Handle Click
        function handleClick(event) {
            if (gameState === 'waiting') {
                // Too early!
                clearTimeout(timeoutId);
                const gameArea = document.getElementById('gameArea');
                gameArea.className = 'game-area early';
                document.getElementById('instruction').textContent = 'Too early! Click to try again';
                gameState = 'early';
                currentRound--;
            } else if (gameState === 'ready') {
                // Create ripple effect on click
                createRipple(event);
                
                // Calculate reaction time
                const reactionTime = Date.now() - startTime;
                reactionTimes.push(reactionTime);
                
                document.getElementById('instruction').textContent = `${reactionTime}ms - Nice!`;
                gameState = 'result';
                
                setTimeout(() => {
                    nextRound();
                }, 1500);
            } else if (gameState === 'early') {
                nextRound();
            }
        }

        // End Game
        function endGame() {
            gameState = 'idle';
            hideElement('gameArea');
            
            // Calculate average - check if we have reaction times
            if (reactionTimes.length === 0) {
                console.error('No reaction times recorded!');
                avgReactionTime = 0;
            } else {
                avgReactionTime = Math.round(reactionTimes.reduce((a, b) => a + b, 0) / reactionTimes.length);
            }
            
            console.log('Reaction times:', reactionTimes);
            console.log('Average reaction time:', avgReactionTime);
            
            // Calculate rounds survived (based on reaction time)
            let roundsSurvived;
            if (avgReactionTime < 200) {
                roundsSurvived = "‚àû";
            } else if (avgReactionTime < 250) {
                roundsSurvived = "50+";
            } else if (avgReactionTime < 300) {
                roundsSurvived = "30";
            } else if (avgReactionTime < 350) {
                roundsSurvived = "20";
            } else if (avgReactionTime < 400) {
                roundsSurvived = "10";
            } else {
                roundsSurvived = "5";
            }
            
            // Update UI elements
            const averageTimeElement = document.getElementById('averageTime');
            const roundsSurvivedElement = document.getElementById('roundsSurvived');
            
            if (averageTimeElement) {
                averageTimeElement.textContent = `${avgReactionTime}ms`;
                console.log('Set averageTime element to:', avgReactionTime + 'ms');
            } else {
                console.error('averageTime element not found!');
            }
            
            if (roundsSurvivedElement) {
                roundsSurvivedElement.textContent = `You'd survive ${roundsSurvived} rounds in VEDICI mode`;
            } else {
                console.error('roundsSurvived element not found!');
            }
            
            // Automatically open email modal to save score
            setTimeout(() => {
                showElement('nameModal');
                document.getElementById('playerName').focus();
            }, 500);
        }

        // Save Score (called from button if needed)
        function saveAndShowLeaderboard() {
            showElement('nameModal');
            document.getElementById('playerName').focus();
        }

        // Skip saving score
        function skipSave() {
            closeModal();
            const resultsScreen = document.getElementById('resultsScreen');
            resultsScreen.style.display = 'flex';
            
            // Make sure average time is visible
            const h2 = resultsScreen.querySelector('h2');
            const time = resultsScreen.querySelector('.result-time');
            const message = resultsScreen.querySelector('.result-message');
            const rounds = resultsScreen.querySelector('.rounds-survived');
            
            if (h2) h2.style.display = 'block';
            if (time) time.style.display = 'block';
            if (message) message.style.display = 'block';
            if (rounds) rounds.style.display = 'block';
            
            loadLeaderboard('leaderboardContainer');
        }

        // Calculate average from leaderboard
        async function calculateLeaderboardAverage() {
            if (!firebaseInitialized || !db) {
                return 0;
            }
            
            try {
                const snapshot = await db.collection('leaderboard')
                    .orderBy('score', 'asc')
                    .limit(100)
                    .get();
                
                if (snapshot.empty) {
                    return 0;
                }
                
                let total = 0;
                let count = 0;
                snapshot.forEach(doc => {
                    const data = doc.data();
                    if (data.score && typeof data.score === 'number') {
                        total += data.score;
                        count++;
                    }
                });
                
                return count > 0 ? Math.round(total / count) : 0;
            } catch (error) {
                console.error('Error calculating leaderboard average:', error);
                return 0;
            }
        }

        // Submit Score to Firebase
        async function submitScore() {
            const emailInput = document.getElementById('playerName');
            const playerEmail = emailInput.value.trim();
            const errorElement = document.getElementById('errorMessage');
            const submitButton = document.getElementById('submitButton');
            const originalButtonText = submitButton.textContent;
            
            // Clear previous errors
            errorElement.textContent = '';
            emailInput.style.border = '2px solid #333';
            
            // HTML5 validation check
            if (!emailInput.checkValidity()) {
                emailInput.style.border = '2px solid #ff3333';
                if (emailInput.validity.valueMissing) {
                    errorElement.textContent = 'Please enter your email address';
                } else if (emailInput.validity.typeMismatch) {
                    errorElement.textContent = 'Please enter a valid email address (e.g., name@example.com)';
                }
                emailInput.reportValidity();
                return;
            }
            
            if (!playerEmail) {
                errorElement.textContent = 'Please enter your email address';
                emailInput.style.border = '2px solid #ff3333';
                emailInput.focus();
                return;
            }
            
            // Additional email validation (more strict)
            const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
            if (!emailRegex.test(playerEmail)) {
                errorElement.textContent = 'Please enter a valid email address';
                emailInput.style.border = '2px solid #ff3333';
                emailInput.focus();
                return;
            }
            
            if (playerEmail.length > 100) {
                errorElement.textContent = 'Email too long (max 100 characters)';
                emailInput.style.border = '2px solid #ff3333';
                emailInput.focus();
                return;
            }
            
            if (!firebaseInitialized || !db) {
                errorElement.textContent = 'Firebase not initialized. Please refresh the page.';
                console.error('Firebase not initialized');
                return;
            }
            
            // Show loading state
            errorElement.textContent = '';
            submitButton.disabled = true;
            submitButton.textContent = 'SAVING...';
            
            try {
                // Calculate average from current leaderboard before saving
                const leaderboardAverage = await calculateLeaderboardAverage();
                
                // Save to Firebase
                await db.collection('leaderboard').add({
                    email: playerEmail,
                    score: avgReactionTime,
                    leaderboardAverage: leaderboardAverage,
                    timestamp: firebase.firestore.FieldValue.serverTimestamp(),
                    date: new Date().toISOString()
                });
                
                console.log('Score saved successfully with leaderboard average:', leaderboardAverage);
                closeModal();
                const resultsScreen = document.getElementById('resultsScreen');
                resultsScreen.style.display = 'flex';
                
                // Make sure all result elements are visible
                const h2 = resultsScreen.querySelector('h2');
                const time = resultsScreen.querySelector('.result-time');
                const message = resultsScreen.querySelector('.result-message');
                const rounds = resultsScreen.querySelector('.rounds-survived');
                
                if (h2) h2.style.display = 'block';
                if (time) time.style.display = 'block';
                if (message) message.style.display = 'block';
                if (rounds) rounds.style.display = 'block';
                
                await loadLeaderboard('leaderboardContainer');
                
            } catch (error) {
                console.error('Error saving score:', error);
                console.error('Error code:', error.code);
                console.error('Error message:', error.message);
                
                let errorMsg = 'Failed to save score. ';
                if (error.code === 'permission-denied') {
                    errorMsg += 'Permission denied. Check Firebase security rules.';
                } else if (error.code === 'unavailable') {
                    errorMsg += 'Firebase service unavailable. Please try again.';
                } else {
                    errorMsg += 'Please try again.';
                }
                
                errorElement.textContent = errorMsg;
            } finally {
                submitButton.disabled = false;
                submitButton.textContent = originalButtonText;
            }
        }

        // Close Modal
        function closeModal() {
            hideElement('nameModal');
            document.getElementById('playerName').value = '';
            document.getElementById('errorMessage').textContent = '';
        }

        // Load Leaderboard
        let currentLeaderboardLimit = 10;
        let currentSelectedDate = null;
        async function loadLeaderboard(containerId, limit = 10, selectedDate = null) {
            const container = document.getElementById(containerId);
            
            // Show loading state
            container.innerHTML = '<div class="loading-state"><div class="loading"></div><p>Loading leaderboard...</p></div>';
            
            if (!firebaseInitialized || !db) {
                container.innerHTML = '<p style="color: #ff3333; text-align: center;">Firebase not initialized. Please refresh the page.</p>';
                console.error('Firebase not initialized');
                return;
            }
            
            try {
                // Load all records and filter by date if specified
                const snapshot = await db.collection('leaderboard')
                    .orderBy('score', 'asc')
                    .get();
                
                // Filter by date if specified
                let filteredDocs = [];
                snapshot.forEach(doc => {
                    const data = doc.data();
                    if (selectedDate) {
                        const recordDate = data.date ? data.date.split('T')[0] : null;
                        if (recordDate === selectedDate) {
                            filteredDocs.push({ id: doc.id, data: data });
                        }
                    } else {
                        filteredDocs.push({ id: doc.id, data: data });
                    }
                });
                
                // Sort by score and limit
                filteredDocs.sort((a, b) => (a.data.score || 0) - (b.data.score || 0));
                filteredDocs = filteredDocs.slice(0, limit);
                
                const dateDisplay = selectedDate ? new Date(selectedDate).toLocaleDateString('en-US', { 
                    weekday: 'long', 
                    year: 'numeric', 
                    month: 'long', 
                    day: 'numeric' 
                }) : 'All Time';
                
                let html = '<div class="leaderboard">';
                html += `<h2>üèÜ ${selectedDate ? 'TOP 10' : 'ELITE'} LEADERBOARD</h2>`;
                html += `<div class="leaderboard-date-info">${selectedDate ? dateDisplay : 'All Time Records'}</div>`;
                
                // Add date picker
                html += '<div class="leaderboard-date-picker">';
                html += '<label for="leaderboardDate">View Top 10 for specific day:</label>';
                html += '<div class="date-picker-wrapper">';
                html += '<input type="date" id="leaderboardDate" value="' + (selectedDate || '') + '">';
                html += '<button class="btn btn-secondary" onclick="applyDateFilter(\'' + containerId + '\')" style="margin-left: 0.5rem; padding: 0.8rem 1.5rem; font-size: 0.9rem; white-space: nowrap;">Apply</button>';
                html += '</div>';
                if (selectedDate) {
                    html += '<button class="btn btn-secondary" onclick="loadLeaderboardByDate(\'' + containerId + '\', null)" style="margin-top: 0.5rem; padding: 0.5rem 1rem; font-size: 0.9rem; width: 100%;">Show All Time</button>';
                }
                html += '</div>';
                
                html += '<ol>';
                
                let rank = 1;
                filteredDocs.forEach(item => {
                    const data = item.data;
                    const medal = rank === 1 ? 'ü•á' : rank === 2 ? 'ü•à' : rank === 3 ? 'ü•â' : '';
                    const displayName = data.email || data.name || 'Anonymous';
                    html += `
                        <li>
                            <span class="rank">${medal || '#' + rank}</span>
                            <span class="player-name">${displayName}</span>
                            <span class="player-score">${data.score}ms</span>
                        </li>
                    `;
                    rank++;
                });
                
                if (rank === 1) {
                    if (selectedDate) {
                        html += '<li style="text-align: center; color: #666;">No scores for this date. Try another day!</li>';
                    } else {
                    html += '<li style="text-align: center; color: #666;">No scores yet. Be the first!</li>';
                    }
                }
                
                html += '</ol>';
                
                // Add "Show More" button only for all-time leaderboard (not for daily)
                if (!selectedDate && limit < 100 && filteredDocs.length === limit) {
                    html += `<button class="btn btn-secondary" onclick="loadMoreLeaderboard('${containerId}')" style="margin-top: 1rem; width: 100%;">SHOW MORE (${limit}/100)</button>`;
                } else if (!selectedDate && limit >= 100) {
                    html += `<div style="text-align: center; color: #888; margin-top: 1rem; font-size: 0.9rem;">Showing all ${rank - 1} records</div>`;
                } else if (selectedDate && filteredDocs.length === 10) {
                    html += `<div style="text-align: center; color: #888; margin-top: 1rem; font-size: 0.9rem;">Top 10 for ${dateDisplay}</div>`;
                }
                
                html += '</div>';
                container.innerHTML = html;
                currentLeaderboardLimit = limit;
                currentSelectedDate = selectedDate;
                
            } catch (error) {
                console.error('Error loading leaderboard:', error);
                console.error('Error code:', error.code);
                console.error('Error message:', error.message);
                
                let errorMsg = '<p style="color: #ff3333; text-align: center;">';
                if (error.code === 'permission-denied') {
                    errorMsg += 'Permission denied. Check Firebase security rules.';
                } else if (error.code === 'unavailable') {
                    errorMsg += 'Firebase service unavailable. Please try again.';
                } else if (error.code === 'failed-precondition') {
                    errorMsg += 'Firestore index required. Check Firebase console.';
                } else {
                    errorMsg += 'Failed to load leaderboard. Please refresh the page.';
                }
                errorMsg += '</p>';
                
                container.innerHTML = errorMsg;
            }
        }

        // Apply Date Filter
        async function applyDateFilter(containerId) {
            const dateInput = document.getElementById('leaderboardDate');
            const selectedDate = dateInput ? dateInput.value : null;
            if (selectedDate) {
                await loadLeaderboard(containerId, 10, selectedDate);
            }
        }

        // Load Leaderboard by Date
        async function loadLeaderboardByDate(containerId, date) {
            if (date) {
                await loadLeaderboard(containerId, 10, date);
            } else {
                await loadLeaderboard(containerId, 100);
            }
        }

        // Load More Leaderboard
        async function loadMoreLeaderboard(containerId) {
            const newLimit = Math.min(currentLeaderboardLimit + 20, 100);
            await loadLeaderboard(containerId, newLimit, currentSelectedDate);
        }

        // Show Leaderboard from Start Screen
        async function showLeaderboard() {
            hideElement('startScreen');
            hideElement('analyticsScreen');
            const resultsScreen = document.getElementById('resultsScreen');
            resultsScreen.style.display = 'flex';
            
            // Hide result elements, show only leaderboard
            const h2 = resultsScreen.querySelector('h2');
            const time = resultsScreen.querySelector('.result-time');
            const message = resultsScreen.querySelector('.result-message');
            const rounds = resultsScreen.querySelector('.rounds-survived');
            const buttonGroup = resultsScreen.querySelector('.button-group');
            
            if (h2) h2.style.display = 'none';
            if (time) time.style.display = 'none';
            if (message) message.style.display = 'none';
            if (rounds) rounds.style.display = 'none';
            if (buttonGroup) buttonGroup.innerHTML = '<button class="btn" onclick="backToStart()">BACK</button>';
            
            // Load full leaderboard (100 records) when viewing from start screen
            await loadLeaderboard('leaderboardContainer', 100);
        }

        // Show Analytics
        async function showAnalytics() {
            hideElement('startScreen');
            hideElement('resultsScreen');
            showElement('analyticsScreen');
            await updateAnalytics();
        }

        // Update Analytics based on selected period
        async function updateAnalytics() {
            if (!firebaseInitialized || !db) {
                document.getElementById('analyticsStats').innerHTML = '<p style="color: #ff3333; text-align: center;">Firebase not initialized.</p>';
                return;
            }

            const periodSelect = document.getElementById('periodSelect');
            const customDateRange = document.getElementById('customDateRange');
            const period = periodSelect.value;

            // Show/hide custom date range
            if (period === 'custom') {
                customDateRange.style.display = 'flex';
            } else {
                customDateRange.style.display = 'none';
            }

            // Calculate date range (using ISO date strings for filtering)
            let startDateStr, endDateStr;
            const now = new Date();
            now.setHours(23, 59, 59, 999); // End of today

            switch (period) {
                case 'today':
                    const today = new Date(now);
                    today.setHours(0, 0, 0, 0);
                    startDateStr = today.toISOString().split('T')[0];
                    endDateStr = now.toISOString().split('T')[0];
                    break;
                case 'yesterday':
                    const yesterday = new Date(now);
                    yesterday.setDate(yesterday.getDate() - 1);
                    yesterday.setHours(0, 0, 0, 0);
                    startDateStr = yesterday.toISOString().split('T')[0];
                    endDateStr = yesterday.toISOString().split('T')[0];
                    break;
                case 'week':
                    const weekAgo = new Date(now);
                    weekAgo.setDate(weekAgo.getDate() - 7);
                    weekAgo.setHours(0, 0, 0, 0);
                    startDateStr = weekAgo.toISOString().split('T')[0];
                    endDateStr = now.toISOString().split('T')[0];
                    break;
                case 'month':
                    const monthAgo = new Date(now);
                    monthAgo.setDate(monthAgo.getDate() - 30);
                    monthAgo.setHours(0, 0, 0, 0);
                    startDateStr = monthAgo.toISOString().split('T')[0];
                    endDateStr = now.toISOString().split('T')[0];
                    break;
                case 'custom':
                    const dateFrom = document.getElementById('dateFrom').value;
                    const dateTo = document.getElementById('dateTo').value;
                    if (!dateFrom || !dateTo) {
                        document.getElementById('analyticsStats').innerHTML = '<p style="color: #888; text-align: center;">Please select date range</p>';
                        return;
                    }
                    startDateStr = dateFrom;
                    endDateStr = dateTo;
                    break;
                default: // 'all'
                    startDateStr = null;
                    endDateStr = null;
            }

            try {
                // Load all records and filter in memory (simpler than complex Firestore queries)
                const snapshot = await db.collection('leaderboard').get();

                let totalGames = 0;
                let totalReactionTime = 0;
                let uniqueEmails = new Set();

                snapshot.forEach(doc => {
                    const data = doc.data();
                    const recordDate = data.date ? data.date.split('T')[0] : null;
                    
                    // Filter by date range if specified
                    if (startDateStr && endDateStr) {
                        if (!recordDate || recordDate < startDateStr || recordDate > endDateStr) {
                            return; // Skip this record
                        }
                    }
                    
                    totalGames++;
                    if (data.score && typeof data.score === 'number') {
                        totalReactionTime += data.score;
                    }
                    if (data.email) {
                        uniqueEmails.add(data.email);
                    }
                });

                const avgReactionTime = totalGames > 0 ? Math.round(totalReactionTime / totalGames) : 0;

                // Update UI
                document.getElementById('totalGames').textContent = totalGames;
                document.getElementById('avgReactionTime').textContent = avgReactionTime > 0 ? avgReactionTime + 'ms' : 'N/A';
                document.getElementById('uniquePlayers').textContent = uniqueEmails.size;

            } catch (error) {
                console.error('Error loading analytics:', error);
                document.getElementById('analyticsStats').innerHTML = '<p style="color: #ff3333; text-align: center;">Error loading analytics. Please try again.</p>';
            }
        }

        // Back to Start
        function backToStart() {
            const resultsScreen = document.getElementById('resultsScreen');
            const analyticsScreen = document.getElementById('analyticsScreen');
            resultsScreen.style.display = 'none';
            analyticsScreen.style.display = 'none';
            
            // Check if analytics URL parameter is present
            const urlParams = new URLSearchParams(window.location.search);
            const analyticsParam = urlParams.get('analytics');
            
            // If analytics parameter is present, show analytics again, otherwise show start screen
            if (analyticsParam === '1' || analyticsParam === 'true') {
                showAnalytics();
            } else {
            showElement('startScreen');
            }
            
            // Reset results screen elements
            const h2 = resultsScreen.querySelector('h2');
            const time = resultsScreen.querySelector('.result-time');
            const message = resultsScreen.querySelector('.result-message');
            const rounds = resultsScreen.querySelector('.rounds-survived');
            const buttonGroup = resultsScreen.querySelector('.button-group');
            
            if (h2) h2.style.display = 'block';
            if (time) time.style.display = 'block';
            if (message) message.style.display = 'block';
            if (rounds) rounds.style.display = 'block';
            if (buttonGroup) {
                buttonGroup.innerHTML = `
                    <button class="btn" onclick="saveAndShowLeaderboard()">SAVE SCORE</button>
                    <button class="btn btn-secondary" onclick="startGame()">PLAY AGAIN</button>
                    <button class="btn btn-secondary" onclick="window.open('https://vedici.gg/gameon', '_blank')">GET YOUR EDGE ‚Üí</button>
                `;
            }
        }

        // Check URL parameter for analytics access (internal team only)
        function checkAnalyticsAccess() {
            const urlParams = new URLSearchParams(window.location.search);
            const analyticsParam = urlParams.get('analytics');
            
            // Only show analytics if URL parameter is present
            if (analyticsParam === '1' || analyticsParam === 'true') {
                // Hide start screen and show analytics directly
                hideElement('startScreen');
                showAnalytics();
            }
        }

        // Keyboard Support for Email Input
        document.addEventListener('DOMContentLoaded', () => {
            // Check for analytics access on page load
            checkAnalyticsAccess();
            
            const emailInput = document.getElementById('playerName');
            
            // Submit on Enter key
            emailInput.addEventListener('keypress', (e) => {
                if (e.key === 'Enter') {
                    e.preventDefault();
                    submitScore();
                }
            });
            
            // Real-time validation feedback
            emailInput.addEventListener('input', (e) => {
                const errorElement = document.getElementById('errorMessage');
                const input = e.target;
                
                if (input.value.trim() === '') {
                    input.style.border = '2px solid #333';
                    errorElement.textContent = '';
                } else if (input.checkValidity()) {
                    input.style.border = '2px solid #d4af37';
                    errorElement.textContent = '';
                } else {
                    input.style.border = '2px solid #ff3333';
                }
            });
            
            // Validate on blur
            emailInput.addEventListener('blur', (e) => {
                const input = e.target;
                const errorElement = document.getElementById('errorMessage');
                
                if (input.value.trim() && !input.checkValidity()) {
                    if (input.validity.typeMismatch) {
                        errorElement.textContent = 'Please enter a valid email address';
                    }
                }
            });
        });
    </script>
</body>
</html>